name: üõ°Ô∏è Gatekeeper - Block Pollution

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-history:
    name: Check for Illegal Merges
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # IMPORTANT: We need full history to scan logs

      - name: Scan Commit Logs
        run: |
          echo "üîç Scanning PR commit history for forbidden merges..."
          
          # Define branches that should NEVER be merged into a feature branch
          # Case insensitive matching for staging, preproduction, master, main
          FORBIDDEN_PATTERN="Merge (remote-tracking )?branch '.*(staging|preproduction|master|main)'"
          
          # Get all commit messages in this PR (from base to head)
          # origin/${{ github.base_ref }} is where we are merging INTO
          COMMITS=$(git log --format='%s' origin/${{ github.base_ref }}..HEAD)
          
          # Check if any commit message matches the forbidden pattern
          if echo "$COMMITS" | grep -iE "$FORBIDDEN_PATTERN"; then
            echo "--------------------------------------------------------"
            echo "üö® VIOLATION DETECTED: Upstream Branch Pollution"
            echo "--------------------------------------------------------"
            echo "You have merged a protected upstream branch (staging/preprod/master)"
            echo "into your feature branch. This is strictly prohibited."
            echo ""
            echo "EVIDENCE (Found in logs):"
            echo "$COMMITS" | grep -iE "$FORBIDDEN_PATTERN"
            echo "--------------------------------------------------------"
            echo "üí° HOW TO FIX:"
            echo "1. Run: git rebase -i HEAD~N (where N is how far back the merge is)"
            echo "2. Drop the merge commit."
            echo "3. Or: Create a fresh branch and cherry-pick your changes."
            echo "--------------------------------------------------------"
            exit 1
          else
            echo "‚úÖ History is clean. No illegal merges found."
            exit 0
          fi